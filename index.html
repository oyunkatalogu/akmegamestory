<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>AkMegaStore</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #1b1b1b; color: #fff; }
    .container { max-width: 400px; margin: auto; background: #333; padding: 20px; border-radius: 10px; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; }
    .catalog { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .game-card {
      width: 200px;
      background: #fff;
      color: #000;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .game-card img { width: 100%; height: 120px; object-fit: cover; }
    iframe { width: 100%; border: none; }
  </style>
</head>
<body>

<div id="authSection" class="container">
  <h2>Giriş Yap</h2>
  <input type="text" id="username" placeholder="Kullanıcı Adı">
  <input type="password" id="password" placeholder="Parola">
  <button onclick="login()">Giriş Yap</button>
  <button onclick="showRegister()">Parolamı Unuttum</button>
  <button onclick="showRegister()">Geri</button>
</div>

<div id="registerSection" class="container" style="display:none;">
  <h2>Kayıt Ol</h2>
  <input type="text" id="regUsername" placeholder="Kullanıcı adı">
  <input type="password" id="regPassword" placeholder="Şifre">
  <button onclick="register()">Kayıt Ol</button>
  <button onclick="showLogin()">Giriş Sayfasına Dön</button>
</div>

<div id="catalogSection" style="display:none;">
  <h2 style="text-align:center;">Oyun Kataloğu</h2>
  <input type="text" id="searchBox" oninput="filterGames()" placeholder="Oyun ara..." style="width:100%;max-width:300px;margin:auto;display:block;">
  <div class="catalog" id="gameCatalog"></div>

  <h2 style="text-align:center;">Favorilerim</h2>
  <div class="catalog" id="favCatalog"></div>

  <h2 style="text-align:center;">Sepetim</h2>
  <div id="cartList" style="text-align:center;"></div>
  <p id="totalPrice" style="text-align:center;">Toplam: 0 TL</p>
  <div style="text-align:center;"><button onclick="sendCartViaWhatsApp()">WhatsApp ile Gönder</button></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBb1dqb3SqYpKtEb3WNt8LSVc4t1SGETe4",
    authDomain: "akmegamestore-66522.firebaseapp.com",
    databaseURL: "https://akmegamestore-66522-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "akmegamestore-66522",
    storageBucket: "akmegamestore-66522.firebasestorage.app",
    messagingSenderId: "89303927223",
    appId: "1:89303927223:web:c1b6bc1231e191a5920032"
  };
  firebase.initializeApp(firebaseConfig);

  function showRegister() {
    document.getElementById("authSection").style.display = "none";
    document.getElementById("registerSection").style.display = "block";
  }

  function showLogin() {
    document.getElementById("registerSection").style.display = "none";
    document.getElementById("authSection").style.display = "block";
  }

  function register() {
    const user = document.getElementById("regUsername").value;
    const pass = document.getElementById("regPassword").value;
    if (user && pass) {
      localStorage.setItem("user", user);
      localStorage.setItem("pass_" + user, pass);
      alert("Kayıt başarılı!");
      showLogin();
    }
  }

  function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    if (localStorage.getItem("pass_" + user) === pass) {
      localStorage.setItem("user", user);
      document.getElementById("authSection").style.display = "none";
      document.getElementById("catalogSection").style.display = "block";
      loadGames();
      renderCart();
    } else {
      alert("Giriş bilgileri hatalı.");
    }
  }

  function toEmbedURL(url) {
    if (!url) return '';
    if (url.includes("youtube.com/embed")) return url;
    if (url.includes("youtu.be/")) return "https://www.youtube.com/embed/" + url.split("youtu.be/")[1].split("?")[0];
    if (url.includes("youtube.com/watch?v=")) return "https://www.youtube.com/embed/" + url.split("v=")[1].split("&")[0];
    return '';
  }

  function getCart() {
    return JSON.parse(localStorage.getItem("cart") || "[]");
  }

  function getFavorites() {
    return JSON.parse(localStorage.getItem("favorites") || "[]");
  }

  function addToCart(code) {
    let cart = getCart();
    if (!cart.includes(code)) {
      cart.push(code);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }
  }

  function removeFromCart(code) {
    let cart = getCart().filter(c => c !== code);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function toggleFavorite(code) {
    let favs = getFavorites();
    if (favs.includes(code)) {
      favs = favs.filter(f => f !== code);
    } else {
      favs.push(code);
    }
    localStorage.setItem("favorites", JSON.stringify(favs));
    loadGames();
  }

  function toggleVideo(code) {
    const el = document.getElementById("video-" + code);
    if (el) {
      el.style.display = el.style.display === "none" ? "block" : "none";
    }
  }

  function loadGames() {
    firebase.database().ref("games").once("value").then(snapshot => {
      const container = document.getElementById("gameCatalog");
      const favContainer = document.getElementById("favCatalog");
      container.innerHTML = '';
      favContainer.innerHTML = '';
      snapshot.forEach(child => {
        const g = child.val();
        const embedLink = toEmbedURL(g.video);
        const div = document.createElement("div");
        div.className = "game-card";
        div.innerHTML = `
          <img src="${g.image}" alt="${g.name}">
          <h3>${g.name}</h3>
          <p>${g.device} / ${g.model}</p>
          <p>${g.price} TL</p>
          <button onclick="addToCart('${g.code}')">Sepete Ekle</button>
          <button onclick="removeFromCart('${g.code}')">Sepetten Çıkar</button>
          <button onclick="toggleFavorite('${g.code}')">Favori</button>
          ${embedLink ? `<button onclick="toggleVideo('${g.code}')">Videoyu Aç / Kapat</button>
          <div id="video-${g.code}" style="display:none; margin-top:10px;">
            <iframe height="150" src="${embedLink}" allowfullscreen></iframe>
          </div>` : ""}
        `;
        (getFavorites().includes(g.code) ? favContainer : container).appendChild(div);
      });
    });
  }

  function renderCart() {
    const cart = getCart();
    let total = 0;
    let html = "<ul>";
    const promises = cart.map(code =>
      firebase.database().ref("games/" + code).once("value").then(snap => {
        const g = snap.val();
        if (g) {
          total += parseFloat(g.price);
          html += `<li>${g.name} - ${g.price} TL</li>`;
        }
      })
    );
    Promise.all(promises).then(() => {
      html += "</ul>";
      document.getElementById("cartList").innerHTML = html;
      document.getElementById("totalPrice").textContent = `Toplam: ${total.toFixed(2)} TL`;
    });
  }

  function sendCartViaWhatsApp() {
    const cart = getCart();
    if (cart.length === 0) return alert("Sepet boş!");
    let message = "Siparişim:
";
    let total = 0;
    const promises = cart.map(code =>
      firebase.database().ref("games/" + code).once("value").then(snap => {
        const g = snap.val();
        if (g) {
          message += `- ${g.name} (${g.price} TL)
`;
          total += parseFloat(g.price);
        }
      })
    );
    Promise.all(promises).then(() => {
      const user = localStorage.getItem("user") || "Bilinmeyen Kullanıcı";
      message += `
Toplam: ${total.toFixed(2)} TL
Kullanıcı: ${user}`;
      const url = "https://wa.me/905548801010?text=" + encodeURIComponent(message);
      window.open(url, "_blank");
    });
  }

  function filterGames() {
    const term = document.getElementById("searchBox").value.toLowerCase();
    const cards = document.querySelectorAll("#gameCatalog .game-card");
    cards.forEach(card => {
      const name = card.querySelector("h3").textContent.toLowerCase();
      card.style.display = name.includes(term) ? "block" : "none";
    });
  }
</script>
</body>
</html>
