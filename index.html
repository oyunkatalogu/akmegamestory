<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Oyun Kataloğu</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    select, button { padding: 10px; margin: 5px; }
    .catalog { display: flex; flex-wrap: wrap; gap: 10px; }
    .game-card {
      background: white;
      border-radius: 10px;
      padding: 10px;
      width: 200px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .game-card img { width: 100%; height: 120px; object-fit: cover; }
  </style>
</head>
<body>
  <h2>Filtrele</h2>
  <select id="filterDevice" onchange="loadModelOptions()"></select>
  <select id="filterModel" onchange="filterGames()"></select>

  <h2>Oyunlar</h2>
  <div class="catalog" id="gameCatalog"></div>

  <h2>Favorilerim</h2>
  <div class="catalog" id="favCatalog"></div>

  <h2>Sepetim</h2>
  <ul id="cartList"></ul>
  <p id="totalPrice">Toplam: 0 TL</p>
  <button onclick="sendCartViaWhatsApp()">WhatsApp ile Gönder</button>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBb1dqb3SqYpKtEb3WNt8LSVc4t1SGETe4",
      authDomain: "akmegamestore-66522.firebaseapp.com",
      databaseURL: "https://akmegamestore-66522-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "akmegamestore-66522",
      storageBucket: "akmegamestore-66522.firebasestorage.app",
      messagingSenderId: "89303927223",
      appId: "1:89303927223:web:c1b6bc1231e191a5920032"
    };
    firebase.initializeApp(firebaseConfig);

    function getCart() {
      return JSON.parse(localStorage.getItem("cart") || "[]");
    }

    function getFavorites() {
      return JSON.parse(localStorage.getItem("favorites") || "[]");
    }

    function addToCart(code) {
      let cart = getCart();
      if (!cart.includes(code)) {
        cart.push(code);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    }

    function removeFromCart(code) {
      let cart = getCart().filter(c => c !== code);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function toggleFavorite(code) {
      let favs = getFavorites();
      if (favs.includes(code)) {
        favs = favs.filter(f => f !== code);
      } else {
        favs.push(code);
      }
      localStorage.setItem("favorites", JSON.stringify(favs));
      filterGames();
    }

    function renderCart() {
      const cart = getCart();
      let html = "";
      let total = 0;
      const promises = cart.map(code =>
        firebase.database().ref("games/" + code).once("value").then(snap => {
          const game = snap.val();
          if (game) {
            total += parseFloat(game.price);
            html += <li>${game.name} - ${game.price} TL</li>;
          }
        })
      );
      Promise.all(promises).then(() => {
        document.getElementById("cartList").innerHTML = html;
        document.getElementById("totalPrice").textContent = "Toplam: " + total.toFixed(2) + " TL";
      });
    }

    function sendCartViaWhatsApp() {
      const cart = getCart();
      if (cart.length === 0) return alert("Sepet boş!");
      let message = "Siparişim:\n";
      let total = 0;
      const promises = cart.map(code =>
        firebase.database().ref('games/' + code).once('value').then(snap => {
          const game = snap.val();
          if (game) {
            message += - ${game.name} (${game.price} TL)\n;
            total += parseFloat(game.price);
          }
        })
      );
      Promise.all(promises).then(() => {
        message += \nToplam: ${total.toFixed(2)} TL;
        const url = "https://wa.me/905548801010?text=" + encodeURIComponent(message);
        window.open(url, "_blank");
      });
    }

    function loadDeviceOptions() {
      firebase.database().ref("devices").once("value").then(snapshot => {
        const sel = document.getElementById("filterDevice");
        sel.innerHTML = "";
        snapshot.forEach(child => {
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = child.key;
          sel.appendChild(opt);
        });
        loadModelOptions();
      });
    }

    function loadModelOptions() {
      const device = document.getElementById("filterDevice").value;
      const modelSel = document.getElementById("filterModel");
      modelSel.innerHTML = "";
      firebase.database().ref("devices/" + device + "/models").once("value").then(snapshot => {
        snapshot.forEach(child => {
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = child.key;
          modelSel.appendChild(opt);
        });
        filterGames();
      });
    }

    function filterGames() {
      const device = document.getElementById("filterDevice").value;
      const model = document.getElementById("filterModel").value;
      firebase.database().ref("games").once("value").then(snapshot => {
        const gameCatalog = document.getElementById("gameCatalog");
        const favCatalog = document.getElementById("favCatalog");
        gameCatalog.innerHTML = "";
        favCatalog.innerHTML = "";
        const favs = getFavorites();
        snapshot.forEach(child => {
          const g = child.val();
          if (g.device === device && g.model === model) {
            const card = document.createElement("div");
            card.className = "game-card";
            card.innerHTML = `
              <img src="${g.image}" alt="${g.name}">
              <h4>${g.name}</h4>
              <p>${g.price} TL</p>
              <button onclick="addToCart('${g.code}')">Sepete Ekle</button>
              <button onclick="removeFromCart('${g.code}')">Sepetten Çıkar</button>
              <button onclick="toggleFavorite('${g.code}')">${favs.includes(g.code) ? "Favoriden Çıkar" : "Favori Ekle"}</button>
            `;
            (favs.includes(g.code) ? favCatalog : gameCatalog).appendChild(card);
          }
        });
      });
    }

    window.addEventListener("load", () => {
      loadDeviceOptions();
      renderCart();
    });
  </script>
</body>
</html>
